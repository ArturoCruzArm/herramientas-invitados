<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Comparar Fotos - Herramientas Foro 7</title>
  <link rel="stylesheet" href="../css/styles.css">
  <style>
    .photo-viewer { text-align: center; margin: 1rem 0; }
    .photo-viewer img {
      max-width: 100%;
      max-height: 65vh;
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      object-fit: contain;
    }
    .photo-name {
      text-align: center;
      font-weight: 600;
      margin-bottom: 0.5rem;
      color: var(--color-text-light);
    }
    .action-buttons {
      display: flex;
      gap: 1rem;
      justify-content: center;
      margin: 1rem 0;
    }
    .action-buttons .btn {
      min-width: 120px;
      font-size: 1.1rem;
      padding: 0.8rem 2rem;
    }
    .download-options {
      display: flex;
      flex-direction: column;
      gap: 0.75rem;
      margin-top: 1.5rem;
    }
    .download-row {
      display: flex;
      gap: 0.5rem;
      flex-wrap: wrap;
      justify-content: center;
    }
    .download-section h3 {
      font-size: 0.95rem;
      margin-bottom: 0.5rem;
      color: var(--color-text-light);
      text-align: center;
    }
    .script-note {
      background: var(--color-bg);
      padding: 0.8rem 1rem;
      border-radius: 8px;
      font-size: 0.82rem;
      color: var(--color-text-light);
      margin-top: 0.5rem;
      text-align: center;
    }
  </style>
</head>
<body>
  <header class="site-header">
    <a href="../" class="back-link" title="Volver">&larr;</a>
    <h1>Comparar Fotos</h1>
  </header>

  <main>
    <div class="tool-container">
      <!-- Paso 1: Seleccionar fotos -->
      <div id="step-load">
        <div class="drop-zone" id="drop-zone">
          <div class="icon">&#8644;</div>
          <p>Arrastra fotos aqui</p>
          <p class="hint">Clasifica una por una como SI o NO</p>
        </div>
        <input type="file" id="file-input" accept="image/*" multiple>
      </div>

      <!-- Paso 2: Clasificar una por una -->
      <div id="step-classify" class="hidden">
        <div id="status" class="mb-1"></div>

        <div class="progress-bar" id="progress">
          <div class="fill" style="width:0%"></div>
        </div>

        <div class="photo-name" id="photo-name"></div>

        <div class="photo-viewer">
          <img id="current-photo" src="" alt="Foto actual">
        </div>

        <div class="action-buttons">
          <button class="btn btn-danger" id="btn-no">NO (N)</button>
          <button class="btn btn-outline" id="btn-undo" disabled>Deshacer (Z)</button>
          <button class="btn btn-success" id="btn-yes">SI (S)</button>
        </div>

        <div class="keyboard-hint">
          <kbd>S</kbd> = SI &nbsp; <kbd>N</kbd> = NO &nbsp; <kbd>Z</kbd> = Deshacer
        </div>

        <div class="stats mt-2">
          <div class="stat">
            <div class="value" id="stat-si">0</div>
            <div class="label">SI</div>
          </div>
          <div class="stat">
            <div class="value" id="stat-no">0</div>
            <div class="label">NO</div>
          </div>
          <div class="stat">
            <div class="value" id="stat-remaining">0</div>
            <div class="label">Restantes</div>
          </div>
        </div>
      </div>

      <!-- Paso 3: Descargar -->
      <div id="step-done" class="hidden">
        <div class="alert alert-success text-center" id="done-msg"></div>

        <div class="stats mt-2">
          <div class="stat">
            <div class="value" id="final-si">0</div>
            <div class="label">SI</div>
          </div>
          <div class="stat">
            <div class="value" id="final-no">0</div>
            <div class="label">NO</div>
          </div>
        </div>

        <div class="download-options">
          <!-- Descargar fotos -->
          <div class="download-section">
            <h3>Descargar fotos</h3>
            <div class="download-row">
              <button class="btn btn-success" id="btn-dl-si">Descargar SI</button>
              <button class="btn btn-danger" id="btn-dl-no">Descargar NO</button>
              <button class="btn btn-primary" id="btn-dl-folders">Guardar ambas en carpetas</button>
            </div>
          </div>

          <!-- Descargar scripts -->
          <div class="download-section">
            <h3>Descargar script para mover en tu PC</h3>
            <div class="download-row">
              <button class="btn btn-outline" id="btn-script-win">Windows (.bat)</button>
              <button class="btn btn-outline" id="btn-script-mac">Mac / Linux (.sh)</button>
            </div>
            <p class="script-note">
              El script crea carpetas SI/ y NO/ y mueve los archivos.
              Ejecutalo en la misma carpeta donde estan las fotos originales.
            </p>
          </div>
        </div>
      </div>
    </div>
  </main>

  <footer class="site-footer">
    Foro 7 &mdash; Herramientas para procesamiento de fotos
  </footer>

  <script src="../js/common.js"></script>
  <script>
    const dropZone = document.getElementById('drop-zone');
    const fileInput = document.getElementById('file-input');
    const stepLoad = document.getElementById('step-load');
    const stepClassify = document.getElementById('step-classify');
    const stepDone = document.getElementById('step-done');

    let photos = [];
    let currentIdx = 0;
    let classifications = []; // { file, choice: 'SI'|'NO' }

    setupDropZone(dropZone, fileInput, handleFiles);

    function handleFiles(files) {
      photos = Array.from(files).filter(f => f.type.startsWith('image/'));
      if (!photos.length) return;
      photos.sort((a, b) => a.name.localeCompare(b.name, undefined, { numeric: true }));
      currentIdx = 0;
      classifications = [];
      hide(stepLoad);
      show(stepClassify);
      showPhoto();
    }

    async function showPhoto() {
      if (currentIdx >= photos.length) {
        finalize();
        return;
      }
      const file = photos[currentIdx];
      const url = await readAsDataURL(file);
      document.getElementById('current-photo').src = url;
      document.getElementById('photo-name').textContent =
        `${file.name} (${currentIdx + 1} de ${photos.length})`;
      updateProgress(document.getElementById('progress'),
        Math.round((currentIdx / photos.length) * 100));
      updateStats();
      document.getElementById('btn-undo').disabled = classifications.length === 0;
    }

    function classify(choice) {
      if (currentIdx >= photos.length) return;
      classifications.push({ file: photos[currentIdx], choice });
      currentIdx++;
      showPhoto();
    }

    function undo() {
      if (!classifications.length) return;
      classifications.pop();
      currentIdx--;
      showPhoto();
    }

    function updateStats() {
      const si = classifications.filter(c => c.choice === 'SI').length;
      const no = classifications.filter(c => c.choice === 'NO').length;
      document.getElementById('stat-si').textContent = si;
      document.getElementById('stat-no').textContent = no;
      document.getElementById('stat-remaining').textContent = photos.length - currentIdx;
    }

    function finalize() {
      hide(stepClassify);
      show(stepDone);
      const siList = classifications.filter(c => c.choice === 'SI');
      const noList = classifications.filter(c => c.choice === 'NO');
      document.getElementById('done-msg').textContent =
        `Clasificacion completa: ${siList.length} SI, ${noList.length} NO`;
      document.getElementById('final-si').textContent = siList.length;
      document.getElementById('final-no').textContent = noList.length;

      // Ocultar botones si no hay fotos en esa categoria
      document.getElementById('btn-dl-si').style.display = siList.length ? '' : 'none';
      document.getElementById('btn-dl-no').style.display = noList.length ? '' : 'none';
    }

    // Botones de clasificacion
    document.getElementById('btn-yes').addEventListener('click', () => classify('SI'));
    document.getElementById('btn-no').addEventListener('click', () => classify('NO'));
    document.getElementById('btn-undo').addEventListener('click', undo);

    // Teclado
    document.addEventListener('keydown', e => {
      if (stepClassify.classList.contains('hidden')) return;
      const key = e.key.toLowerCase();
      if (key === 's') classify('SI');
      else if (key === 'n') classify('NO');
      else if (key === 'z') undo();
    });

    // ===== Descargas =====

    function getFilesBy(choice) {
      return classifications
        .filter(c => c.choice === choice)
        .map(c => ({ name: c.file.name, data: c.file }));
    }

    // Descargar solo SI
    document.getElementById('btn-dl-si').addEventListener('click', () => {
      downloadAll(getFilesBy('SI'));
    });

    // Descargar solo NO
    document.getElementById('btn-dl-no').addEventListener('click', () => {
      downloadAll(getFilesBy('NO'));
    });

    // Guardar ambas en carpetas
    document.getElementById('btn-dl-folders').addEventListener('click', () => {
      saveToFolders({ SI: getFilesBy('SI'), NO: getFilesBy('NO') });
    });

    // ===== Generar Scripts =====

    function generateWinScript() {
      const siFiles = classifications.filter(c => c.choice === 'SI').map(c => c.file.name);
      const noFiles = classifications.filter(c => c.choice === 'NO').map(c => c.file.name);

      let script = '@echo off\r\n';
      script += 'chcp 65001 >nul\r\n';
      script += 'echo Clasificando fotos...\r\n';
      script += 'echo.\r\n';

      if (siFiles.length) {
        script += 'if not exist "SI" mkdir "SI"\r\n';
        for (const f of siFiles) {
          script += `if exist "${f}" move "${f}" "SI\\${f}"\r\n`;
        }
      }

      if (noFiles.length) {
        script += 'if not exist "NO" mkdir "NO"\r\n';
        for (const f of noFiles) {
          script += `if exist "${f}" move "${f}" "NO\\${f}"\r\n`;
        }
      }

      script += 'echo.\r\n';
      script += `echo Listo: ${siFiles.length} fotos a SI, ${noFiles.length} fotos a NO\r\n`;
      script += 'pause\r\n';
      return script;
    }

    function generateMacScript() {
      const siFiles = classifications.filter(c => c.choice === 'SI').map(c => c.file.name);
      const noFiles = classifications.filter(c => c.choice === 'NO').map(c => c.file.name);

      let script = '#!/bin/bash\n';
      script += '# Clasificar fotos en carpetas SI y NO\n';
      script += '# Ejecutar en la carpeta donde estan las fotos\n\n';

      if (siFiles.length) {
        script += 'mkdir -p "SI"\n';
        for (const f of siFiles) {
          script += `[ -f "${f}" ] && mv "${f}" "SI/${f}"\n`;
        }
      }

      if (noFiles.length) {
        script += '\nmkdir -p "NO"\n';
        for (const f of noFiles) {
          script += `[ -f "${f}" ] && mv "${f}" "NO/${f}"\n`;
        }
      }

      script += `\necho "Listo: ${siFiles.length} fotos a SI, ${noFiles.length} fotos a NO"\n`;
      return script;
    }

    document.getElementById('btn-script-win').addEventListener('click', () => {
      const blob = new Blob([generateWinScript()], { type: 'text/plain' });
      downloadBlob(blob, 'clasificar_fotos.bat');
    });

    document.getElementById('btn-script-mac').addEventListener('click', () => {
      const blob = new Blob([generateMacScript()], { type: 'text/plain' });
      downloadBlob(blob, 'clasificar_fotos.sh');
    });
  </script>
</body>
</html>
