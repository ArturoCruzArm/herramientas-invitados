<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Comparar Fotos - Herramientas Foro 7</title>
  <link rel="stylesheet" href="../css/styles.css">
  <style>
    .compare-container {
      display: flex;
      gap: 1rem;
      justify-content: center;
      align-items: flex-start;
      margin: 1rem 0;
    }
    .compare-side {
      flex: 1;
      max-width: 48%;
      text-align: center;
      border: 3px solid var(--color-border);
      border-radius: var(--radius);
      overflow: hidden;
      display: flex;
      flex-direction: column;
      transition: border-color var(--transition);
    }
    .compare-side.chose-si { border-color: var(--color-success); }
    .compare-side.chose-no { border-color: var(--color-error); }
    .compare-side img {
      width: 100%;
      aspect-ratio: 4/3;
      object-fit: contain;
      background: var(--color-bg);
    }
    .compare-side .photo-label {
      padding: 0.4rem 0.5rem;
      font-size: 0.82rem;
      font-weight: 600;
      background: var(--color-bg);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .compare-side .side-buttons {
      display: flex;
      gap: 0.5rem;
      padding: 0.5rem;
      justify-content: center;
    }
    .compare-side .side-buttons .btn { flex: 1; font-size: 0.95rem; }
    .single-container { max-width: 500px; margin: 1rem auto; text-align: center; }
    .single-container img {
      max-height: 60vh;
      max-width: 100%;
      object-fit: contain;
      border-radius: var(--radius);
      margin-bottom: 0.5rem;
    }
    .nav-buttons { display: flex; gap: 0.5rem; justify-content: center; margin: 0.5rem 0; }
    @media (max-width: 600px) {
      .compare-container { flex-direction: column; }
      .compare-side { max-width: 100%; }
    }
  </style>
</head>
<body>
  <header class="site-header">
    <a href="../" class="back-link" title="Volver">&larr;</a>
    <h1>Comparar Fotos</h1>
  </header>

  <main>
    <div class="tool-container">
      <!-- Paso 1: Seleccionar fotos -->
      <div id="step-load">
        <div class="drop-zone" id="drop-zone">
          <div class="icon">&#8644;</div>
          <p>Arrastra fotos aqui</p>
          <p class="hint">Se muestran de dos en dos, clasifica cada una SI o NO</p>
        </div>
        <input type="file" id="file-input" accept="image/*" multiple>
      </div>

      <!-- Paso 2: Comparar -->
      <div id="step-compare" class="hidden">
        <div id="status" class="mb-1"></div>

        <div class="progress-bar" id="progress">
          <div class="fill" style="width:0%"></div>
        </div>

        <!-- Modo dos fotos -->
        <div id="mode-pair">
          <div class="compare-container">
            <div class="compare-side" id="side-left">
              <img id="img-left" src="" alt="Foto izquierda">
              <div class="photo-label" id="label-left"></div>
              <div class="side-buttons">
                <button class="btn btn-success" id="btn-left-si">SI (A)</button>
                <button class="btn btn-danger" id="btn-left-no">NO (Z)</button>
              </div>
            </div>
            <div class="compare-side" id="side-right">
              <img id="img-right" src="" alt="Foto derecha">
              <div class="photo-label" id="label-right"></div>
              <div class="side-buttons">
                <button class="btn btn-success" id="btn-right-si">SI (D)</button>
                <button class="btn btn-danger" id="btn-right-no">NO (C)</button>
              </div>
            </div>
          </div>
          <div class="keyboard-hint">
            Izquierda: <kbd>A</kbd> = SI &nbsp; <kbd>Z</kbd> = NO &nbsp;&nbsp;|&nbsp;&nbsp;
            Derecha: <kbd>D</kbd> = SI &nbsp; <kbd>C</kbd> = NO &nbsp;&nbsp;|&nbsp;&nbsp;
            <kbd>U</kbd> = Deshacer
          </div>
        </div>

        <!-- Modo una foto (cuando queda impar) -->
        <div id="mode-single" class="hidden">
          <div class="single-container">
            <p class="photo-name" id="single-name"></p>
            <img id="img-single" src="" alt="Foto">
            <div class="nav-buttons">
              <button class="btn btn-success" id="btn-single-si">SI (S)</button>
              <button class="btn btn-danger" id="btn-single-no">NO (N)</button>
            </div>
          </div>
          <div class="keyboard-hint">
            <kbd>S</kbd> = SI &nbsp; <kbd>N</kbd> = NO
          </div>
        </div>

        <div class="nav-buttons mt-1">
          <button class="btn btn-outline" id="btn-undo" disabled>Deshacer (U)</button>
        </div>

        <div class="stats mt-2">
          <div class="stat">
            <div class="value" id="stat-si">0</div>
            <div class="label">SI</div>
          </div>
          <div class="stat">
            <div class="value" id="stat-no">0</div>
            <div class="label">NO</div>
          </div>
          <div class="stat">
            <div class="value" id="stat-remaining">0</div>
            <div class="label">Restantes</div>
          </div>
        </div>
      </div>

      <!-- Paso 3: Descargar -->
      <div id="step-done" class="hidden">
        <div class="alert alert-success text-center" id="done-msg"></div>
        <div class="stats mt-2">
          <div class="stat">
            <div class="value" id="final-si">0</div>
            <div class="label">SI</div>
          </div>
          <div class="stat">
            <div class="value" id="final-no">0</div>
            <div class="label">NO</div>
          </div>
        </div>
        <div class="btn-group mt-2" style="justify-content:center">
          <button class="btn btn-success" id="btn-download">Guardar en carpetas</button>
        </div>
      </div>
    </div>
  </main>

  <footer class="site-footer">
    Foro 7 &mdash; Herramientas para procesamiento de fotos
  </footer>

  <script src="../js/common.js"></script>
  <script>
    const dropZone = document.getElementById('drop-zone');
    const fileInput = document.getElementById('file-input');
    const stepLoad = document.getElementById('step-load');
    const stepCompare = document.getElementById('step-compare');
    const stepDone = document.getElementById('step-done');
    const modePair = document.getElementById('mode-pair');
    const modeSingle = document.getElementById('mode-single');
    const sideLeft = document.getElementById('side-left');
    const sideRight = document.getElementById('side-right');

    let photos = [];
    let pairIdx = 0;
    let pairs = [];       // [[file1, file2], ...]
    let singleFile = null;
    let results = [];      // { file, choice: 'SI'|'NO' }
    // Para cada par guardamos las decisiones pendientes
    let leftChoice = null;
    let rightChoice = null;
    let history = [];      // snapshots para deshacer

    setupDropZone(dropZone, fileInput, handleFiles);

    function handleFiles(files) {
      photos = Array.from(files).filter(f => f.type.startsWith('image/'));
      if (!photos.length) return;
      photos.sort((a, b) => a.name.localeCompare(b.name, undefined, { numeric: true }));

      pairs = [];
      singleFile = null;
      for (let i = 0; i < photos.length - 1; i += 2) {
        pairs.push([photos[i], photos[i + 1]]);
      }
      if (photos.length % 2 === 1) {
        singleFile = photos[photos.length - 1];
      }

      pairIdx = 0;
      results = [];
      history = [];
      leftChoice = null;
      rightChoice = null;

      hide(stepLoad);
      show(stepCompare);
      showCurrentPair();
    }

    async function showCurrentPair() {
      if (pairIdx >= pairs.length) {
        if (singleFile) {
          showSingle();
        } else {
          finalize();
        }
        return;
      }

      show(modePair);
      hide(modeSingle);
      leftChoice = null;
      rightChoice = null;
      sideLeft.className = 'compare-side';
      sideRight.className = 'compare-side';

      const [left, right] = pairs[pairIdx];
      const [urlL, urlR] = await Promise.all([readAsDataURL(left), readAsDataURL(right)]);
      document.getElementById('img-left').src = urlL;
      document.getElementById('img-right').src = urlR;
      document.getElementById('label-left').textContent = left.name;
      document.getElementById('label-right').textContent = right.name;

      const total = pairs.length + (singleFile ? 1 : 0);
      document.getElementById('status').innerHTML =
        `<div class="alert alert-info">Par ${pairIdx + 1} de ${total}</div>`;
      updateProgress(document.getElementById('progress'), Math.round((pairIdx / total) * 100));
      updateStats();
      document.getElementById('btn-undo').disabled = history.length === 0;
    }

    async function showSingle() {
      hide(modePair);
      show(modeSingle);
      const url = await readAsDataURL(singleFile);
      document.getElementById('img-single').src = url;
      document.getElementById('single-name').textContent = singleFile.name;

      const total = pairs.length + 1;
      document.getElementById('status').innerHTML =
        `<div class="alert alert-info">Foto ${total} de ${total} (individual)</div>`;
      updateProgress(document.getElementById('progress'), Math.round((pairs.length / total) * 100));
      updateStats();
    }

    function classifyLeft(choice) {
      if (leftChoice !== null) return;
      leftChoice = choice;
      sideLeft.className = 'compare-side chose-' + choice.toLowerCase();
      checkPairDone();
    }

    function classifyRight(choice) {
      if (rightChoice !== null) return;
      rightChoice = choice;
      sideRight.className = 'compare-side chose-' + choice.toLowerCase();
      checkPairDone();
    }

    function checkPairDone() {
      if (leftChoice === null || rightChoice === null) return;
      const [left, right] = pairs[pairIdx];

      history.push({
        type: 'pair',
        pairIdx: pairIdx,
        resultsCount: results.length
      });

      results.push({ file: left, choice: leftChoice });
      results.push({ file: right, choice: rightChoice });
      pairIdx++;

      setTimeout(() => showCurrentPair(), 300);
    }

    function classifySingle(choice) {
      if (!singleFile) return;
      history.push({
        type: 'single',
        resultsCount: results.length
      });
      results.push({ file: singleFile, choice });
      singleFile = null;
      finalize();
    }

    function undo() {
      if (!history.length) return;
      const last = history.pop();
      results.splice(last.resultsCount);

      if (last.type === 'pair') {
        pairIdx = last.pairIdx;
        showCurrentPair();
      } else {
        singleFile = photos[photos.length - 1];
        showSingle();
      }
    }

    function updateStats() {
      const si = results.filter(r => r.choice === 'SI').length;
      const no = results.filter(r => r.choice === 'NO').length;
      const remaining = photos.length - results.length;
      document.getElementById('stat-si').textContent = si;
      document.getElementById('stat-no').textContent = no;
      document.getElementById('stat-remaining').textContent = remaining;
      document.getElementById('btn-undo').disabled = history.length === 0;
    }

    function finalize() {
      hide(stepCompare);
      show(stepDone);
      const si = results.filter(r => r.choice === 'SI').length;
      const no = results.filter(r => r.choice === 'NO').length;
      document.getElementById('done-msg').textContent =
        `Listo: ${si} foto(s) SI, ${no} foto(s) NO`;
      document.getElementById('final-si').textContent = si;
      document.getElementById('final-no').textContent = no;
    }

    // Botones
    document.getElementById('btn-left-si').addEventListener('click', () => classifyLeft('SI'));
    document.getElementById('btn-left-no').addEventListener('click', () => classifyLeft('NO'));
    document.getElementById('btn-right-si').addEventListener('click', () => classifyRight('SI'));
    document.getElementById('btn-right-no').addEventListener('click', () => classifyRight('NO'));
    document.getElementById('btn-undo').addEventListener('click', undo);
    document.getElementById('btn-single-si').addEventListener('click', () => classifySingle('SI'));
    document.getElementById('btn-single-no').addEventListener('click', () => classifySingle('NO'));

    // Teclado
    document.addEventListener('keydown', e => {
      if (stepCompare.classList.contains('hidden')) return;
      const key = e.key.toLowerCase();

      if (!modeSingle.classList.contains('hidden')) {
        if (key === 's') classifySingle('SI');
        else if (key === 'n') classifySingle('NO');
      } else {
        if (key === 'a') classifyLeft('SI');
        else if (key === 'z') classifyLeft('NO');
        else if (key === 'd') classifyRight('SI');
        else if (key === 'c') classifyRight('NO');
        else if (key === 'u') undo();
      }
    });

    // Descargar en carpetas
    document.getElementById('btn-download').addEventListener('click', async () => {
      const si = results.filter(r => r.choice === 'SI').map(r => ({ name: r.file.name, data: r.file }));
      const no = results.filter(r => r.choice === 'NO').map(r => ({ name: r.file.name, data: r.file }));
      await saveToFolders({ SI: si, NO: no });
    });
  </script>
</body>
</html>
