<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Comparar Fotos - Herramientas Foro 7</title>
  <link rel="icon" href="../favicon.svg" type="image/svg+xml">
  <link rel="stylesheet" href="../css/styles.css">
  <style>
    .compare-container {
      display: flex;
      gap: 1rem;
      justify-content: center;
      align-items: flex-start;
      margin: 1rem 0;
    }
    .compare-side {
      flex: 1;
      max-width: 48%;
      text-align: center;
      border: 3px solid var(--color-border);
      border-radius: var(--radius);
      overflow: hidden;
      display: flex;
      flex-direction: column;
      transition: border-color 0.3s;
    }
    .compare-side img {
      width: 100%;
      aspect-ratio: 4/3;
      object-fit: contain;
      background: var(--color-bg);
    }
    .compare-side .photo-label {
      padding: 0.4rem 0.5rem;
      font-size: 0.82rem;
      font-weight: 600;
      background: var(--color-bg);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .compare-side .side-buttons {
      display: flex;
      gap: 0.5rem;
      padding: 0.5rem;
      justify-content: center;
    }
    .compare-side .side-buttons .btn { flex: 1; font-size: 0.95rem; }
    .single-view { max-width: 500px; margin: 1rem auto; text-align: center; }
    .single-view img {
      max-height: 60vh; max-width: 100%;
      object-fit: contain; border-radius: var(--radius);
      box-shadow: var(--shadow); margin-bottom: 0.5rem;
    }
    .single-buttons { display: flex; gap: 0.5rem; justify-content: center; margin: 0.5rem 0; }
    .download-options { display: flex; flex-direction: column; gap: 0.75rem; margin-top: 1.5rem; }
    .download-row { display: flex; gap: 0.5rem; flex-wrap: wrap; justify-content: center; }
    .download-section h3 { font-size: 0.95rem; margin-bottom: 0.5rem; color: var(--color-text-light); text-align: center; }
    .script-note {
      background: var(--color-bg); padding: 0.8rem 1rem; border-radius: 8px;
      font-size: 0.82rem; color: var(--color-text-light); margin-top: 0.5rem; text-align: center;
    }
    .flash-si { animation: flashSi 0.3s; }
    .flash-no { animation: flashNo 0.3s; }
    @keyframes flashSi { 0%,100%{ border-color: var(--color-border); } 50%{ border-color: var(--color-success); } }
    @keyframes flashNo { 0%,100%{ border-color: var(--color-border); } 50%{ border-color: var(--color-error); } }
    @media (max-width: 600px) {
      .compare-container { flex-direction: column; }
      .compare-side { max-width: 100%; }
    }
  </style>
</head>
<body>
  <header class="site-header">
    <a href="../" class="back-link" title="Volver">&larr;</a>
    <h1>Comparar Fotos</h1>
  </header>

  <main>
    <div class="tool-container">
      <!-- Paso 1: Seleccionar -->
      <div id="step-load">
        <div class="drop-zone" id="drop-zone">
          <div class="icon">&#8644;</div>
          <p>Arrastra fotos aqui</p>
          <p class="hint">Compara dos fotos y clasifica cada una SI o NO</p>
        </div>
        <input type="file" id="file-input" accept="image/*" multiple>
      </div>

      <!-- Paso 2: Comparar -->
      <div id="step-compare" class="hidden">
        <div id="status" class="mb-1"></div>
        <div class="progress-bar" id="progress"><div class="fill" style="width:0%"></div></div>

        <!-- Modo dos fotos -->
        <div id="mode-pair" class="hidden">
          <div class="compare-container">
            <div class="compare-side" id="side-left">
              <img id="img-left" src="" alt="Foto izquierda">
              <div class="photo-label" id="label-left"></div>
              <div class="side-buttons">
                <button class="btn btn-success btn-left-si">SI (A)</button>
                <button class="btn btn-danger btn-left-no">NO (Z)</button>
              </div>
            </div>
            <div class="compare-side" id="side-right">
              <img id="img-right" src="" alt="Foto derecha">
              <div class="photo-label" id="label-right"></div>
              <div class="side-buttons">
                <button class="btn btn-success btn-right-si">SI (D)</button>
                <button class="btn btn-danger btn-right-no">NO (C)</button>
              </div>
            </div>
          </div>
          <div class="keyboard-hint">
            Izquierda: <kbd>A</kbd> SI / <kbd>Z</kbd> NO &nbsp;&nbsp;|&nbsp;&nbsp;
            Derecha: <kbd>D</kbd> SI / <kbd>C</kbd> NO
          </div>
        </div>

        <!-- Modo una foto (ultima) -->
        <div id="mode-single" class="hidden">
          <div class="single-view">
            <p class="photo-name" id="single-name"></p>
            <img id="img-single" src="" alt="Ultima foto">
            <div class="single-buttons">
              <button class="btn btn-success" id="btn-single-si">SI (S)</button>
              <button class="btn btn-danger" id="btn-single-no">NO (N)</button>
            </div>
          </div>
          <div class="keyboard-hint"><kbd>S</kbd> SI &nbsp; <kbd>N</kbd> NO</div>
        </div>

        <div class="stats mt-2">
          <div class="stat"><div class="value" id="stat-si">0</div><div class="label">SI</div></div>
          <div class="stat"><div class="value" id="stat-no">0</div><div class="label">NO</div></div>
          <div class="stat"><div class="value" id="stat-remaining">0</div><div class="label">Restantes</div></div>
        </div>
      </div>

      <!-- Paso 3: Resultado -->
      <div id="step-done" class="hidden">
        <div class="alert alert-success text-center" id="done-msg"></div>
        <div class="stats mt-2">
          <div class="stat"><div class="value" id="final-si">0</div><div class="label">SI</div></div>
          <div class="stat"><div class="value" id="final-no">0</div><div class="label">NO</div></div>
        </div>
        <div class="download-options">
          <div class="download-section">
            <h3>Descargar fotos</h3>
            <div class="download-row">
              <button class="btn btn-success" id="btn-dl-si">Descargar SI</button>
              <button class="btn btn-danger" id="btn-dl-no">Descargar NO</button>
              <button class="btn btn-primary" id="btn-dl-folders">Guardar ambas en carpetas</button>
            </div>
          </div>
          <div class="download-section">
            <h3>Descargar script para mover en tu PC</h3>
            <div class="download-row">
              <button class="btn btn-outline" id="btn-script-win">Windows (.bat)</button>
              <button class="btn btn-outline" id="btn-script-mac">Mac / Linux (.sh)</button>
            </div>
            <p class="script-note">
              El script crea carpetas SI/ y NO/ y mueve los archivos.
              Ejecutalo en la misma carpeta donde estan las fotos originales.
            </p>
          </div>
        </div>
      </div>
    </div>
  </main>

  <footer class="site-footer">Foro 7 &mdash; Herramientas para procesamiento de fotos</footer>

  <script src="../js/common.js"></script>
  <script>
    const dropZone = document.getElementById('drop-zone');
    const fileInput = document.getElementById('file-input');
    const stepLoad = document.getElementById('step-load');
    const stepCompare = document.getElementById('step-compare');
    const stepDone = document.getElementById('step-done');
    const modePair = document.getElementById('mode-pair');
    const modeSingle = document.getElementById('mode-single');
    const sideLeft = document.getElementById('side-left');
    const sideRight = document.getElementById('side-right');

    let photos = [];      // cola de fotos sin clasificar
    let nextIdx = 0;      // siguiente foto a cargar de la cola
    let leftFile = null;  // foto actual en slot izquierdo
    let rightFile = null; // foto actual en slot derecho
    let results = [];     // { file, choice }
    let total = 0;
    let busy = false;

    setupDropZone(dropZone, fileInput, handleFiles);

    function handleFiles(files) {
      photos = Array.from(files).filter(f => f.type.startsWith('image/'));
      if (photos.length < 2) { alert('Se necesitan al menos 2 fotos'); return; }
      photos.sort((a, b) => a.name.localeCompare(b.name, undefined, { numeric: true }));
      total = photos.length;
      nextIdx = 0;
      results = [];
      leftFile = null;
      rightFile = null;
      busy = false;

      hide(stepLoad);
      show(stepCompare);

      // Cargar las dos primeras
      leftFile = photos[nextIdx++];
      rightFile = photos[nextIdx++];
      showPair();
    }

    async function showPair() {
      show(modePair);
      hide(modeSingle);
      await Promise.all([
        loadSide('left', leftFile),
        loadSide('right', rightFile)
      ]);
      updateUI();
    }

    async function loadSide(side, file) {
      const url = await readAsDataURL(file);
      document.getElementById('img-' + side).src = url;
      document.getElementById('label-' + side).textContent = file.name;
    }

    async function showLast(file) {
      hide(modePair);
      show(modeSingle);
      const url = await readAsDataURL(file);
      document.getElementById('img-single').src = url;
      document.getElementById('single-name').textContent = file.name;
      updateUI();
    }

    function classifySide(side, choice) {
      if (busy) return;
      busy = true;

      const file = side === 'left' ? leftFile : rightFile;
      results.push({ file, choice });

      // Flash visual
      const el = side === 'left' ? sideLeft : sideRight;
      el.classList.add(choice === 'SI' ? 'flash-si' : 'flash-no');
      setTimeout(() => el.classList.remove('flash-si', 'flash-no'), 300);

      // Cargar siguiente foto en ese slot
      if (nextIdx < photos.length) {
        const newFile = photos[nextIdx++];
        if (side === 'left') leftFile = newFile;
        else rightFile = newFile;

        setTimeout(async () => {
          await loadSide(side, newFile);
          updateUI();
          busy = false;
        }, 200);
      } else {
        // Ya no hay mas fotos en cola, queda una sola sin clasificar
        const remaining = side === 'left' ? rightFile : leftFile;
        setTimeout(() => {
          leftFile = null;
          rightFile = null;
          showLast(remaining);
          busy = false;
        }, 200);
      }
    }

    function classifyLast(choice) {
      if (busy) return;
      // La foto que queda en modo single
      const el = modeSingle.querySelector('img');
      const file = photos.find(p =>
        !results.some(r => r.file === p)
      );
      if (file) results.push({ file, choice });
      finalize();
    }

    function updateUI() {
      const classified = results.length;
      const remaining = total - classified;
      document.getElementById('stat-si').textContent = results.filter(r => r.choice === 'SI').length;
      document.getElementById('stat-no').textContent = results.filter(r => r.choice === 'NO').length;
      document.getElementById('stat-remaining').textContent = remaining;
      document.getElementById('status').innerHTML =
        `<div class="alert alert-info">${classified} de ${total} clasificadas</div>`;
      updateProgress(document.getElementById('progress'), Math.round((classified / total) * 100));
    }

    function finalize() {
      hide(stepCompare);
      show(stepDone);
      const si = results.filter(r => r.choice === 'SI').length;
      const no = results.filter(r => r.choice === 'NO').length;
      document.getElementById('done-msg').textContent = `Listo: ${si} SI, ${no} NO`;
      document.getElementById('final-si').textContent = si;
      document.getElementById('final-no').textContent = no;
      document.getElementById('btn-dl-si').style.display = si ? '' : 'none';
      document.getElementById('btn-dl-no').style.display = no ? '' : 'none';
    }

    // ===== Botones =====
    document.querySelector('.btn-left-si').addEventListener('click', () => classifySide('left', 'SI'));
    document.querySelector('.btn-left-no').addEventListener('click', () => classifySide('left', 'NO'));
    document.querySelector('.btn-right-si').addEventListener('click', () => classifySide('right', 'SI'));
    document.querySelector('.btn-right-no').addEventListener('click', () => classifySide('right', 'NO'));
    document.getElementById('btn-single-si').addEventListener('click', () => classifyLast('SI'));
    document.getElementById('btn-single-no').addEventListener('click', () => classifyLast('NO'));

    // ===== Teclado =====
    document.addEventListener('keydown', e => {
      if (stepCompare.classList.contains('hidden')) return;
      const key = e.key.toLowerCase();
      if (!modeSingle.classList.contains('hidden')) {
        if (key === 's') classifyLast('SI');
        else if (key === 'n') classifyLast('NO');
      } else {
        if (key === 'a') classifySide('left', 'SI');
        else if (key === 'z') classifySide('left', 'NO');
        else if (key === 'd') classifySide('right', 'SI');
        else if (key === 'c') classifySide('right', 'NO');
      }
    });

    // ===== Descargas =====
    function getFilesBy(choice) {
      return results.filter(r => r.choice === choice).map(r => ({ name: r.file.name, data: r.file }));
    }

    document.getElementById('btn-dl-si').addEventListener('click', () => downloadAll(getFilesBy('SI')));
    document.getElementById('btn-dl-no').addEventListener('click', () => downloadAll(getFilesBy('NO')));
    document.getElementById('btn-dl-folders').addEventListener('click', () => {
      saveToFolders({ SI: getFilesBy('SI'), NO: getFilesBy('NO') });
    });

    // ===== Scripts =====
    function generateWinScript() {
      const si = results.filter(r => r.choice === 'SI').map(r => r.file.name);
      const no = results.filter(r => r.choice === 'NO').map(r => r.file.name);
      let s = '@echo off\r\nchcp 65001 >nul\r\necho Clasificando fotos...\r\necho.\r\n';
      if (si.length) { s += 'if not exist "SI" mkdir "SI"\r\n'; si.forEach(f => s += `if exist "${f}" move "${f}" "SI\\${f}"\r\n`); }
      if (no.length) { s += 'if not exist "NO" mkdir "NO"\r\n'; no.forEach(f => s += `if exist "${f}" move "${f}" "NO\\${f}"\r\n`); }
      s += `echo.\r\necho Listo: ${si.length} fotos a SI, ${no.length} fotos a NO\r\npause\r\n`;
      return s;
    }

    function generateMacScript() {
      const si = results.filter(r => r.choice === 'SI').map(r => r.file.name);
      const no = results.filter(r => r.choice === 'NO').map(r => r.file.name);
      let s = '#!/bin/bash\n# Ejecutar en la carpeta de las fotos\n\n';
      if (si.length) { s += 'mkdir -p "SI"\n'; si.forEach(f => s += `[ -f "${f}" ] && mv "${f}" "SI/${f}"\n`); }
      if (no.length) { s += '\nmkdir -p "NO"\n'; no.forEach(f => s += `[ -f "${f}" ] && mv "${f}" "NO/${f}"\n`); }
      s += `\necho "Listo: ${si.length} fotos a SI, ${no.length} fotos a NO"\n`;
      return s;
    }

    document.getElementById('btn-script-win').addEventListener('click', () => {
      downloadBlob(new Blob([generateWinScript()], { type: 'text/plain' }), 'clasificar_fotos.bat');
    });
    document.getElementById('btn-script-mac').addEventListener('click', () => {
      downloadBlob(new Blob([generateMacScript()], { type: 'text/plain' }), 'clasificar_fotos.sh');
    });
  </script>
</body>
</html>
