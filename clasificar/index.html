<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Clasificar Fotos - Herramientas Foro 7</title>
  <link rel="stylesheet" href="../css/styles.css">
  <style>
    .action-buttons { display: flex; gap: 1rem; justify-content: center; margin: 1rem 0; }
    .action-buttons .btn { min-width: 120px; font-size: 1.1rem; padding: 0.8rem 2rem; }
    .photo-name { text-align: center; font-weight: 600; margin-bottom: 0.5rem; color: var(--color-text-light); }
    .rotate-controls { display: flex; gap: 0.5rem; justify-content: center; margin-bottom: 0.5rem; }
  </style>
</head>
<body>
  <header class="site-header">
    <a href="../" class="back-link" title="Volver">&larr;</a>
    <h1>Clasificar Fotos</h1>
  </header>

  <main>
    <div class="tool-container">
      <!-- Paso 1: Seleccionar fotos -->
      <div id="step-load">
        <div class="drop-zone" id="drop-zone">
          <div class="icon">&#9989;</div>
          <p>Arrastra fotos y videos aqui</p>
          <p class="hint">o haz clic para seleccionar (los videos se separan automaticamente)</p>
        </div>
        <input type="file" id="file-input" accept="image/*,video/*" multiple>
      </div>

      <!-- Paso 2: Clasificar -->
      <div id="step-classify" class="hidden">
        <div id="status" class="mb-1"></div>

        <div class="progress-bar" id="progress">
          <div class="fill" style="width:0%"></div>
        </div>

        <div class="photo-name" id="photo-name"></div>

        <div class="rotate-controls">
          <button class="btn btn-outline" id="btn-rotate-left" title="Rotar 90 izquierda">&#8634; Izq (Q)</button>
          <button class="btn btn-outline" id="btn-rotate-right" title="Rotar 90 derecha">&#8635; Der (R)</button>
        </div>

        <div class="photo-viewer">
          <img id="current-photo" src="" alt="Foto actual">
        </div>

        <div class="action-buttons">
          <button class="btn btn-danger" id="btn-no">NO (N)</button>
          <button class="btn btn-outline" id="btn-undo" disabled>Deshacer (Z)</button>
          <button class="btn btn-success" id="btn-yes">SI (S)</button>
        </div>

        <div class="keyboard-hint">
          Teclas: <kbd>S</kbd> = SI &nbsp; <kbd>N</kbd> = NO &nbsp; <kbd>Z</kbd> = Deshacer &nbsp; <kbd>Q</kbd> = Rotar izq &nbsp; <kbd>R</kbd> = Rotar der
        </div>

        <div class="stats mt-2" id="stats">
          <div class="stat">
            <div class="value" id="stat-si">0</div>
            <div class="label">SI</div>
          </div>
          <div class="stat">
            <div class="value" id="stat-no">0</div>
            <div class="label">NO</div>
          </div>
          <div class="stat">
            <div class="value" id="stat-videos">0</div>
            <div class="label">Videos</div>
          </div>
          <div class="stat">
            <div class="value" id="stat-remaining">0</div>
            <div class="label">Restantes</div>
          </div>
        </div>
      </div>

      <!-- Paso 3: Descargar -->
      <div id="step-done" class="hidden">
        <div class="alert alert-success text-center" id="done-msg"></div>
        <div class="stats mt-2">
          <div class="stat">
            <div class="value" id="final-si">0</div>
            <div class="label">SI</div>
          </div>
          <div class="stat">
            <div class="value" id="final-no">0</div>
            <div class="label">NO</div>
          </div>
          <div class="stat">
            <div class="value" id="final-videos">0</div>
            <div class="label">Videos</div>
          </div>
        </div>
        <div class="btn-group mt-2" style="justify-content:center">
          <button class="btn btn-success" id="btn-download">Descargar archivos</button>
        </div>
      </div>
    </div>
  </main>

  <footer class="site-footer">
    Foro 7 &mdash; Herramientas para procesamiento de fotos
  </footer>

  <script src="../js/common.js"></script>
  <script>
    const VIDEO_EXTS = ['mp4', 'mov', 'avi', 'mkv', 'flv', 'wmv', '3gp', 'webm'];
    const dropZone = document.getElementById('drop-zone');
    const fileInput = document.getElementById('file-input');
    const stepLoad = document.getElementById('step-load');
    const stepClassify = document.getElementById('step-classify');
    const stepDone = document.getElementById('step-done');

    let photos = [];
    let videos = [];
    let currentIdx = 0;
    let classifications = []; // { file, choice: 'SI'|'NO', rotation }
    let rotation = 0;

    setupDropZone(dropZone, fileInput, handleFiles);

    function handleFiles(files) {
      const allFiles = Array.from(files).filter(f => !f.name.startsWith('._'));
      photos = [];
      videos = [];

      for (const f of allFiles) {
        const ext = f.name.split('.').pop().toLowerCase();
        if (VIDEO_EXTS.includes(ext) || f.type.startsWith('video/')) {
          videos.push(f);
        } else if (f.type.startsWith('image/') || /\.(jpe?g|png|gif|bmp|webp|heic)$/i.test(f.name)) {
          photos.push(f);
        }
      }

      if (!photos.length && !videos.length) return;

      photos.sort((a, b) => a.name.localeCompare(b.name, undefined, { numeric: true }));
      currentIdx = 0;
      classifications = [];
      rotation = 0;

      if (videos.length) {
        document.getElementById('stat-videos').textContent = videos.length;
      }

      if (!photos.length) {
        finalize();
        return;
      }

      hide(stepLoad);
      show(stepClassify);
      showPhoto();
    }

    async function showPhoto() {
      if (currentIdx >= photos.length) {
        finalize();
        return;
      }
      rotation = 0;
      const file = photos[currentIdx];
      const url = await readAsDataURL(file);
      document.getElementById('current-photo').src = url;
      document.getElementById('current-photo').style.transform = '';
      document.getElementById('photo-name').textContent = `${file.name} (${currentIdx + 1} de ${photos.length})`;
      updateProgress(document.getElementById('progress'), Math.round((currentIdx / photos.length) * 100));
      updateStats();
      document.getElementById('btn-undo').disabled = classifications.length === 0;
    }

    function classify(choice) {
      if (currentIdx >= photos.length) return;
      classifications.push({ file: photos[currentIdx], choice, rotation });
      currentIdx++;
      showPhoto();
    }

    function undo() {
      if (!classifications.length) return;
      classifications.pop();
      currentIdx--;
      showPhoto();
    }

    function rotatePhoto(degrees) {
      rotation = ((rotation + degrees) % 360 + 360) % 360;
      document.getElementById('current-photo').style.transform = `rotate(${rotation}deg)`;
    }

    function updateStats() {
      const si = classifications.filter(c => c.choice === 'SI').length;
      const no = classifications.filter(c => c.choice === 'NO').length;
      document.getElementById('stat-si').textContent = si;
      document.getElementById('stat-no').textContent = no;
      document.getElementById('stat-videos').textContent = videos.length;
      document.getElementById('stat-remaining').textContent = photos.length - currentIdx;
    }

    function finalize() {
      hide(stepClassify);
      show(stepDone);
      const si = classifications.filter(c => c.choice === 'SI').length;
      const no = classifications.filter(c => c.choice === 'NO').length;
      document.getElementById('done-msg').textContent =
        `Clasificacion completa: ${photos.length} fotos` + (videos.length ? ` y ${videos.length} videos` : '');
      document.getElementById('final-si').textContent = si;
      document.getElementById('final-no').textContent = no;
      document.getElementById('final-videos').textContent = videos.length;
    }

    /** Aplica rotacion a una imagen y devuelve el blob resultante */
    async function applyRotation(file, degrees) {
      if (degrees === 0) return file;
      const dataUrl = await readAsDataURL(file);
      const img = await loadImage(dataUrl);
      const rad = (degrees * Math.PI) / 180;
      const canvas = document.createElement('canvas');
      const absSin = Math.abs(Math.sin(rad));
      const absCos = Math.abs(Math.cos(rad));
      canvas.width = Math.round(img.naturalWidth * absCos + img.naturalHeight * absSin);
      canvas.height = Math.round(img.naturalWidth * absSin + img.naturalHeight * absCos);
      const ctx = canvas.getContext('2d');
      ctx.translate(canvas.width / 2, canvas.height / 2);
      ctx.rotate(rad);
      ctx.drawImage(img, -img.naturalWidth / 2, -img.naturalHeight / 2);
      return new Promise(resolve => canvas.toBlob(resolve, 'image/jpeg', 0.95));
    }

    document.getElementById('btn-yes').addEventListener('click', () => classify('SI'));
    document.getElementById('btn-no').addEventListener('click', () => classify('NO'));
    document.getElementById('btn-undo').addEventListener('click', undo);
    document.getElementById('btn-rotate-left').addEventListener('click', () => rotatePhoto(-90));
    document.getElementById('btn-rotate-right').addEventListener('click', () => rotatePhoto(90));

    document.addEventListener('keydown', e => {
      if (stepClassify.classList.contains('hidden')) return;
      const key = e.key.toLowerCase();
      if (key === 's') classify('SI');
      else if (key === 'n') classify('NO');
      else if (key === 'z') undo();
      else if (key === 'q') rotatePhoto(-90);
      else if (key === 'r') rotatePhoto(90);
    });

    document.getElementById('btn-download').addEventListener('click', async () => {
      const files = [];

      for (const c of classifications) {
        const prefix = c.choice + '_';
        if (c.rotation !== 0) {
          const rotatedBlob = await applyRotation(c.file, c.rotation);
          files.push({ name: prefix + c.file.name, data: rotatedBlob });
        } else {
          files.push({ name: prefix + c.file.name, data: c.file });
        }
      }

      for (const v of videos) {
        files.push({ name: 'VIDEOS_' + v.name, data: v });
      }

      await downloadAll(files);
    });
  </script>
</body>
</html>
